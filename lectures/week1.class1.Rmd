---
title: "Statistical Methods for Insurance: Randomisation"
author: "Di Cook & Souhaib Ben Taieb, Econometrics and Business Statistics, Monash University"
date: "W1.C1"
output:
  ioslides_presentation:
    transition: default
    widescreen: yes
css: default.css
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(
  message = FALSE,
  cache = FALSE,
  fig.height = 2,
  fig.width = 5,
  collapse = TRUE,
  comment = "#>"
)
options(digits=2)
library(dplyr)
library(tidyr)
```

## What is randomness?

- Coin flip
- Die roll
- Your sporting team wins
- Gender of a baby
- Rain tomorrow
- Stock price in an hour from now
- Lightning strike
- Pipe burst

## Your turn

We are going to play a game of "Stump the Professor". 

1. Flip a coin. If it shows up tails do A first, if it shows up heads to B first. 

  `A. Write down a sequence of heads and tails that you might expect to come from TEN flips of a coin`
  
  `B. Now flip a coin TEN times, and write down the outcomes`

2. Enter these in the online sheet. Make a note to yourself, whether you did A or B first, but don't tell me. 

3. Now I am going to look at what you entered, and guess if were made up, or actual outcomes from coin flips. 

4. You record how many times I get it right. 

## How to use randomization to understand probability

```{r echo=FALSE, fig.width=10, fig.height=4}
library(eechidna)
library(dplyr)
library(ggplot2)
aec2013 <- aec2013_2cp_electorate %>%
  filter(Elected == "Y")
aec_abs <- merge(aec2013, abs2011, by = "Electorate")
aec_abs$PartyGp <- aec_abs$PartyAb
aec_abs$PartyGp[aec_abs$PartyGp %in% c("LP","LNP","NP","CLP")] <- "Coalition"
aec_abs$PartyGp[aec_abs$PartyGp %in% c("IND","PUP","KAP","GRN")] <- "Other"
ggplot(data=aec_abs, aes(x=Population)) + geom_dotplot(binwidth=2900) +
  facet_wrap(~PartyGp, ncol = 3) + ylab("")
```

## Your turn

- What is the difference (roughly) in population between the biggest and smallest electorates?
- What is the relative worth of a voter in the electorate with the largest population, compared to a voter in the electorate with the smallest population?

##

- Ideally all electorates have exactly the same number of people.
- Geography can interfere with this, e.g an electorate cannot be part in Tasmania and part in Victoria.
- The Australian Electoral Commission will adjust geographic boundaries before each election to adjust for population changes as measured in the most recent Census.

## Compute averages

```{r echo=FALSE}
aec_abs_means <- aec_abs %>% filter(PartyGp != "Other") %>%
  group_by(PartyGp) %>%
  summarise(m = mean(Population, na.rm=T), s = sd(Population, na.rm=T))
aec_abs_means
```

##

- The means are different
- How big is this difference?
- How likely is this difference to have arisen by chance?

We could use a two-sample t-test to answer these, but here is how to do the equivalent by randomization.

## Procedure

1. Compute the statistic for the data (e.g. absolute value of mean difference)
2. Shuffle the group labels (e.g. put the MP party names into a hat, mix them around, draw them and assign to new electorate)
3. Compute the statistic for this shuffled data
4. Repeat steps 2, 3 many times
5. Examine how often the value of the data statistic, or a larger value occurs

## Let's do it

```{r echo=FALSE, fig.height=4, fig.width=4}
library(purrr)
mad <- function(df, shuffle=TRUE) {
  if (shuffle)
    df$PartyGp <- sample(df$PartyGp)
  df_means <- df %>% group_by(PartyGp) %>%
    summarise(m = mean(Population, na.rm=T))
  return(d = abs(df_means$m[1] - df_means$m[2]))
}
aec_abs_sub <- aec_abs %>% filter(PartyGp != "Other")
aec_abs_meandif <- mad(aec_abs_sub, shuffle=FALSE)
aec_abs_shuffle <-1:100 %>% map_dbl(~ mad(aec_abs_sub))
aec_abs_shuffle <- data.frame(d=aec_abs_shuffle, y=1:100)
ggplot(data=aec_abs_shuffle, aes(x=d)) + geom_dotplot() +
  geom_vline(xintercept=aec_abs_meandif, colour="red")
```

Let's also count the number of times that we see a bigger difference by chance. It is `r length(aec_abs_shuffle$d[aec_abs_shuffle$d > aec_abs_meandif])`. 

## What does this mean?

If we oberve this many times `r length(aec_abs_shuffle$d[aec_abs_shuffle$d > aec_abs_meandif])` out of `r length(aec_abs_shuffle$d)` random shuffles, is it likely to see this electorate distribution by chance?

## Using permutation to examine association

Example from DBCR: 

*The participants in this study were 48 male bank supervisors attending a management institute at the University of North Carolina in 1972. They were asked to assume the role of the personnel director of a bank and were given a personnel file to judge whether the person should be promoted to a branch manager position. The files given to the participants were identical, except that half of them indicated the candidate was male and the other half indicated the candidate was female. These files were randomly assigned to the subjects.*

## Your turn

Is this an observational study or an experiment? How does
the type of study impact what can be inferred from the results?

##

```{r echo=FALSE}
bank <- data.frame(gender=c(rep("male", 24), rep("female", 24)), 
                   decision=c(rep("promoted", 21), rep("not promoted", 3), 
                              rep("promoted", 14), rep("not promoted", 10)))
```

```{r echo=FALSE, eval=FALSE}
bank %>% group_by(gender, decision) %>%
  tally() %>% 
  spread(decision, n) %>%
  kable(format.args=list(width=80))
```

```{r echo=FALSE}
kable(addmargins(table(bank$gender, bank$decision)))
kable(prop.table(table(bank$gender, bank$decision), 1))
```

## How likely is this?
 
1. Break any association between gender and decision
2. Re-tabulate
3. Compute proportion of women promoted

##

Original: 

```{r echo=FALSE}
kable(head(bank, 10))
```

##

Permuted decision:

```{r echo=FALSE}
set.seed(4664)
bank.p <- bank %>% mutate(decision=sample(decision))
kable(head(bank.p, 10))
```

